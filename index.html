<!DOCTYPE html>
<html>
    <head>
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
        <title>Draggable</title>
        <style>

            * {
                font-family: Arial, Helvetica, sans-serif;
            }

            .grid * {
                position: absolute;
            }

            .node {
                position: absolute;
                width: 95px; /* the border is 1px, padding is 2px + 2px, for a total of 100px */
                height: 95px;
                background-color: rgba(100, 100, 100, 0.2);
                left: 50%;
                top: 50%;
                padding: 2px;
                border: 1px solid black;
                border-radius: 4px;
                user-select: none;
            }
            footer {
                position: absolute;
            }

            .hLine {
                opacity: 0.1;
                z-index: 1;
                width: 100%;
                height: 1px;
                background-color: black;
            }

            .vLine {
                opacity: 0.1;
                z-index: 1;
                height: 100%;
                width: 1px;
                background-color: black;
            }

            html * {
                z-index: 2;
            }

            #edit-modal{
                display: none;
                position: fixed;
                width: 100%;
                height: 100%;
                z-index: 99;
            }

            #edit-modal-content {
                z-index: 100;
                position: absolute;
                left: 0px;
                top: 0px;
                width: 200px;
                height: 150px;
                border: 1px solid black;
                background-color: rgba(255, 255, 255, 1);
                padding: 4px;
                margin: 0px auto 0px auto;
            }

            .button {
                border: 1px solid black;
                padding: 2px;
                border-radius: 2px;
                background-color: rgba(100, 100, 100, 0.2);
                margin: 2px;
                font-size: 14px;
            }
            .button:hover {
                background-color: rgba(100, 100, 100, 0.4);

            }
            .button:active{
                background-color: rgba(100, 100, 100, 0.6);

            }

            #edit-modal-color {
                display: none;
            }
            #edit-modal-color div {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                align-items: center;
            }

        </style>
    </head>
    <body id="body">
        <div class="grid" id="hGrid"></div>
        <div class="grid" id="vGrid"></div>
        <footer>
            <button onclick="addNode()" class="button">add node</button>
            <input type="number" name="tickvals" id="tickvals" min="0" max="1000" step="50" value="0">
        </footer>  
        <div id="edit-modal">
            <span id="edit-modal-content">
                <span id="edit-modal-main">
                    <h4>node #<span id="modalNumNode"></span></h4>
                    <button onclick="deleteNode(modalNode)" class="button">delete node</button>
                    <button onclick='showSubMenu("edit-modal-color")' class="button">change color</button>
                </span>
                <span id="edit-modal-color">
                    <div id="r"><span id="r-title">R</span><input type="range" min="0" max="255" val="100" id="r-slider"><span id="r-val">100</span></div>
                    <div id="g"><span id="g-title">G</span><input type="range" min="0" max="255" val="100" id="g-slider"><span id="g-val">100</span></div>
                    <div id="b"><span id="b-title">B</span><input type="range" min="0" max="255" val="100" id="b-slider"><span id="b-val">100</span></div>
                </span>
            </span>
        </div>
        
        <script>
                //size of node (in pixels)
                const len = 100;
                //current mouse pos
                let mouseX = 0;
                let mouseY = 0;
                //the OG mouse pos when user first clicked the node
                let prevMouseX = 0;
                let prevMouseY = 0;
                //original offsets for the node when user first clicked
                let ogNodeX;
                let ogNodeY;

                let currentNode = null;
                let modalNode = null;

                let mouseDown = false;
                let allowAltClick = true;
                let modalShown = true;

                let numNodes = 0;
                //grid snap (in pixels)
                let tick = 0;

                //the edit modal (only 1 can show at a time)
                let edit = document.getElementById("edit-modal-content");

                /**
                 * keep track of all RGB values for each node
                 * [
                 *   [r, g, b] //rgb vals for node 0
                 *   [r, g, b] //rgb vals for node 1
                 *   ...
                 * ]
                 */
                let backgrounds = new Array();

                document.getElementById("tickvals").addEventListener("change", (event) => {
                    //set the tick value and re-draw the lines
                    tick = parseInt(document.getElementById("tickvals").value);
                    if (tick != 0){
                        rewriteGrid();
                        if (currentNode != null) snapToGrid();
                       
                    }
                });

                document.addEventListener("mouseup", (event) => {
                    //set variables to false and snap node to grid
                    mouseDown = false;
                    firstTime = false;
                    if (currentNode != null){
                        snapToGrid();
                        currentNode = null;
                    }
                    
                });

                document.getElementById("r-slider").addEventListener("mousemove", (event) => {
                    document.getElementById("r-val").innerText = document.getElementById("r-slider").value;
                    updateRGB(modalNode);
                });
                document.getElementById("g-slider").addEventListener("mousemove", (event) => {
                    document.getElementById("g-val").innerText = document.getElementById("g-slider").value;
                    updateRGB(modalNode);
                });
                document.getElementById("b-slider").addEventListener("mousemove", (event) => {
                    document.getElementById("b-val").innerText = document.getElementById("b-slider").value;
                    updateRGB(modalNode);
                });

                document.addEventListener("mousedown", (event) => {
                    //if the modal is open see if user clicked on the modal or outside of the modal (to close it)
                    if (modalShown){
                        if (event.target == document.getElementById("edit-modal")){
                            modalShown = false;
                            hideEdit();
                        }
                    }
                    //if the alt button was not clicked, alert code that its the first button click (and not a drag)
                    if (event.button != 2){
                        mouseDown = true;
                        firstTime = true;
                    } else {
                        //if the alt button was clicked, check if it was clicked on while the mouse was over a node
                        for (let node of document.getElementsByClassName("node")) {
                            if (event.target == node){
                                //open the edit menu
                                showEdit(node);
                            }
                        }
                    }
                });

                //dont use browser settings for alt click if its over a node (use custom edit menu instead) or if custom edit menu is open
                document.addEventListener("contextmenu", (event) => {
                    if (!allowAltClick || modalShown) event.preventDefault();
                });

                document.addEventListener("mousemove", (event) => {
                    updateCoords();
                    //if a node is being dragged or hovering over a node, dont allow the default edit menu 
                    allowAltClick = true;
                    if (currentNode == null) {
                        for (let node of document.getElementsByClassName("node")) {
                            if (event.target == node) allowAltClick = false;
                            //if the mouse is down over a certain node, select it to drag
                            if (mouseDown) currentNode = node;
                        }
                    } else {
                        allowAltClick = false;
                        //if the mouse is still down and the edit menu isnt shown, drag it
                        if (mouseDown && !modalShown) {
                            moveCurrentNode();
                        }
                    }
                });

                //move the currently selected drag node. if its the first drag, take note of the original coordinates of the node/mouse to use as translation pointers
                function moveCurrentNode() {
                        if (firstTime) {
                            tempX = mouseX;
                            tempY = mouseY;
                            ogNodeX = currentNode.offsetLeft;
                            ogNodeY = currentNode.offsetTop;
                            firstTime = false;
                        }
                        let offsetX = ((mouseX - tempX) + ogNodeX);
                        let offsetY = ((mouseY - tempY) + ogNodeY);
                        currentNode.style.top = offsetY + "px";
                        currentNode.style.left = offsetX + "px";
                }

                //snap the node to the grid (if the grid is used)
                function snapToGrid() {
                    if (tick != 0){
                        //X grid snap
                        let factorX = (currentNode.offsetLeft + (tick/2 - len/2))/tick; //how many times the current X goes into the grid (basically how many tiles across)
                        let belowX = Math.floor(factorX) * tick; //the multiple of the grid tick val that is directly below the current X
                        let belowDiffX = Math.abs(belowX - currentNode.offsetLeft); //the distance between the bottom threshold and current X val
                        let aboveX = belowX + tick; //the multiple of the grid tick val that is directly after the current X (aka after the below threshold)
                        let aboveDiffX = Math.abs(aboveX - currentNode.offsetLeft); //the distance between the top threshold and current X val

                        if (belowDiffX < aboveDiffX){
                            //round down
                            currentNode.style.left = belowX + "px";
                        } else {
                            //round down
                            currentNode.style.left = aboveX + "px";                   
                        }

                        //Y grid snap
                        let factorY = (currentNode.offsetTop + (tick/2 - len/2))/tick; //how many times the current Y goes into the grid (basically how many tiles across)
                        let belowY = Math.floor(factorY) * tick; //the multiple of the grid tick val that is directly below the current Y
                        let belowDiffY = Math.abs(belowY - currentNode.offsetTop); //the distance between the bottom threshold and current Y val
                        let aboveY = belowY + tick; //the multiple of the grid tick val that is directly after the current Y (aka after the below threshold)
                        let aboveDiffY = Math.abs(aboveY - currentNode.offsetTop); //the distance between the top threshold and current Y val

                        if (belowDiffY < aboveDiffY){
                            //round down
                            currentNode.style.top = belowY + "px";
                        } else {
                            //round up
                            currentNode.style.top = aboveY + "px";
                        }
                    }
                }

                //redraws the background lines when the grid changes
                function rewriteGrid(){
                    let hgrid = document.getElementById("hGrid")
                    let vgrid = document.getElementById("vGrid")
                    //first delete existing lines
                    while (hgrid.lastChild){
                        hgrid.removeChild(hgrid.lastChild);
                    }
                    while (vgrid.lastChild){
                        vgrid.removeChild(vgrid.lastChild);
                    }
                    if (tick != 0){
                        //then draw new lines
                    for (let i = (tick/2 + len/2); i < window.outerHeight - tick; i += tick){
                        //make the horizontal line
                        let hLine = document.createElement("div");
                        hLine.setAttribute("class", "hLine gridline");
                        hLine.style.top = i + "px";
                        hgrid.appendChild(hLine);
                    }
                    for (let i = (tick/2 + len/2); i < window.outerWidth; i+= tick){
                        //make the vertical line
                        let vLine = document.createElement("div");
                        vLine.setAttribute("class", "vLine gridline");
                        vLine.style.left = i + "px";
                        vgrid.appendChild(vLine)  
                    }
                    }
                    
                }

                //adds a node with text
                function addNode() {
                    let newNode = document.createElement("div");
                    newNode.setAttribute("class", "node");
                    newNode.innerText = "deez nuts"
                    newNode.setAttribute("id", numNodes.toString());

                    document.getElementById("body").appendChild(newNode)
                    numNodes++;

                    //update the RGB array (we know that the bg is 100, 100, 100)
                    backgrounds.push([100, 100, 100]);
                }

                function updateCoords() {
                    //update the mouse coordinates
                    let e = window.event;
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                }

                //deletes a node and hides the edit menu (you can only delete it if the edit menu is open)
                function deleteNode(node){
                    if (node != null){
                        node.parentNode.removeChild(node);
                        hideEdit();
                    }
                    
                }

                //toggles to a sub-menu of the edit menu
                
                function showSubMenu(prompt){
                    console.log("sub menu")
                    document.getElementById(prompt).style.display = "block";
                    document.getElementById("edit-modal-main").style.display = "none";
                }

                function resetEdit(){
                    console.log("reset")
                    document.getElementById("edit-modal-color").style.display = "none";
                    document.getElementById("edit-modal-main").style.display = "block";
                }

                //show the edit menu and move it to where the mouse alt clicked on the node
                function showEdit(node){
                    console.log("show")
                    modalShown = true;
                    edit.parentNode.style.display = "block";
                    edit.style.left = mouseX + "px";
                    edit.style.top = mouseY + "px";
                    modalNode = node;
                    document.getElementById("modalNumNode").innerText = node.getAttribute("id");
                }

                //hide the edit menu and hide the color sliders
                function hideEdit(){
                    console.log("hide")
                    edit.parentNode.style.display = "none";
                    edit.style.left = "0px";
                    edit.style.top = "0px";

                    modalNode = null;
                    resetEdit();
                }

                //updates the values stored in the array and on the UI
                function updateRGB(node){
                    let r = document.getElementById("r-slider").value;
                    let g = document.getElementById("g-slider").value;
                    let b = document.getElementById("b-slider").value;
                    
                    let index = node.getAttribute("id");

                    backgrounds[index] = [r, g, b];

                    node.style.backgroundColor = "rgba(" + r + ", " + g + ", " + b + ", 0.2)";
                }

        </script>
    </body>
</html>